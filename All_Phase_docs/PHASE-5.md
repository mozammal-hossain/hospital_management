# Phase-5: ভ্যালিডেশন ও পলিশ

**সময়:** প্রায় ২ ঘণ্টা  
**স্টাইল:** গল্প বলার ভঙ্গিতে, টিউটর মোড — বোঝা, তারপর কোড।

---

## একটু পটভূমি

Phase-1 থেকে Phase-4 এ আমরা মডেল, DTO, রিপোজিটরি, API এন্ডপয়েন্ট আর ডেটাবেস (SQLite) দিয়ে একটা পূর্ণ CRUD API বানিয়েছি। ডেটা এখন স্থায়ী; কিন্তু ক্লায়েন্ট যদি ভুল ডেটা পাঠায় — যেমন খালি নাম, ভুল ইমেইল ফরম্যাট, বা অতিরিক্ত লম্বা স্ট্রিং — তাহলে আমরা সেটা সরাসরি ডেটাবেসে ঢুকিয়ে দিচ্ছি। Phase-5 এ আমরা **ভ্যালিডেশন ও পলিশ** যোগ করব: DTO তে ডেটা অ্যানোটেশন দিয়ে নিয়ম বাঁধব, অকার্যকর রিকোয়েস্টে **৪০০ Bad Request** ও ভ্যালিডেশন এরর তালিকা ফিরাব, আর চাইলে **লগিং** বা **হেলথ চেক** এন্ডপয়েন্ট যোগ করব। API টা প্রোডাকশন-কাছাকাছি পরিষ্কার ও নিরাপদ হবে।

এ Phase এ **কোনো নতুন এন্ডপয়েন্ট বা ডেটাবেস পরিবর্তন নয়** — শুধু ডেটা যাচাই, এরর রেসপন্স সুন্দর করা, আর ঐচ্ছিকভাবে অ্যাপ মোনিটরিং (হেলথ, লগ)।

---

## Phase-5 এ কী কী করতে হবে (সংক্ষেপে)

১. **DTO তে ভ্যালিডেশন অ্যানোটেশন** — `CreatePatientRequest` ও `UpdatePatientRequest` এ `[Required]`, `[EmailAddress]`, `[StringLength]`, `[Phone]`, `[Range]` ইত্যাদি যোগ করা।  
২. **মডেল স্টেট চেক** — কন্ট্রোলারে POST/PUT এ রিকোয়েস্ট পাওয়ার পর `ModelState.IsValid` চেক করা; ইনভ্যালিড হলে 400 ও এরর ডিটেইল রিটার্ন।  
৩. **ভ্যালিডেশন এরর রেসপন্স ফরম্যাট** — 400 এ কোন ফিল্ডে কী এরর হয়েছে সেটা ক্লায়েন্ট বুঝতে পারে এমন JSON (যেমন ফিল্ড নাম + মেসেজ তালিকা)।  
৪. **ঐচ্ছিক: গ্লোবাল ভ্যালিডেশন বাহক** — `[ApiController]` থাকলে অটো ভ্যালিডেশন হয়; চাইলে কাস্টম ফিল্টার বা একশন রেজাল্ট দিয়ে রেসপন্স শেপ নিয়ন্ত্রণ।  
৫. **ঐচ্ছিক: লগিং** — রিকোয়েস্ট/রেসপন্স বা এক্সেপশন লগ করার জন্য `ILogger` ব্যবহার বা মিনিমাল মিডলওয়্যার।  
৬. **ঐচ্ছিক: হেলথ চেক** — `/health` বা `/api/health` এন্ডপয়েন্ট যেখানে ডেটাবেস কানেক্টিভিটি চেক করে 200/503 দেয়।

নিচে প্রতিটা ধাপ Flutter এর সাথে মিলিয়ে বর্ণনা করা হলো।

---

## ১. DTO তে ভ্যালিডেশন অ্যানোটেশন

**কী করবে:**  
`CreatePatientRequest` ও `UpdatePatientRequest` ক্লাসের প্রপার্টিগুলোর ওপর ডেটা অ্যানোটেশন যোগ করবে। নিউগেট প্যাকেজ: `System.ComponentModel.Annotations` (প্রজেক্টে সাধারণত আগে থেকেই রেফারেন্স থাকে)। উদাহরণ:

- **FullName:** `[Required(ErrorMessage = "নাম বাধ্যতামূলক")]`, `[StringLength(200, MinimumLength = 1)]`
- **Email:** `[EmailAddress(ErrorMessage = "সঠিক ইমেইল দিন")]` — Create এ Required চাইলে `[Required]` দেবে।
- **PhoneNumber:** `[Phone]` বা `[RegularExpression(...)]` — ফোন ফরম্যাটের জন্য।
- **DateOfBirth:** `[Range]` বা কাস্টম ভ্যালিডেশন — ভবিষ্যত তারিখ যেন না হয়।
- **UpdatePatientRequest** — যে ফিল্ডগুলো আপডেটে পাঠানো যাবে সেগুলোতে একই রকম অ্যানোটেশন; Optional ফিল্ড রাখতে পারো (Required না দিলে খালি পাঠালে আপডেটে সেটা স্কিপ করবে)।

মনে রাখো: Create এ সাধারণত FullName, DateOfBirth, Gender ইত্যাদি Required; Update এ অনেক ফিল্ড optional (শুধু বদলানোরগুলো পাঠালেই হয়)।

**Flutter এর সাথে তুলনা:**  
Flutter এ আমরা `flutter_form_builder` বা নিজের ভ্যালিডেটর দিয়ে `validator: (v) => v.isEmpty ? 'নাম দিন' : null` লিখি। .NET এ অ্যানোটেশনই সেই “নিয়ম” — সার্ভার সাইডে একবার লিখলে সব ক্লায়েন্ট (ওয়েব, মোবাইল) একই নিয়ম পায়।

---

## ২. মডেল স্টেট চেক ও 400 রেসপন্স

**কী করবে:**  
`PatientsController` এর POST ও PUT অ্যাকশনে, রিকোয়েস্ট বডি বাইন্ড হওয়ার পরেই চেক করবে:

```csharp
if (!ModelState.IsValid)
    return BadRequest(ModelState);
```

অথবা ভ্যালিডেশন এররগুলো একটা সুন্দর স্ট্রাকচারে (যেমন `{ "errors": { "FullName": ["নাম বাধ্যতামূলক"], "Email": ["সঠিক ইমেইল দিন"] } }`) রিটার্ন করতে চাইলে সেই অবজেক্ট বানিয়ে `BadRequest(yourObject)` দেবে। `[ApiController]` অ্যাট্রিবিউট থাকলে অটোমেটিকভাবে মডেল বাইন্ডের পর ভ্যালিডেশন চালায় — কিন্তু এক্সপ্লিসিট `if (!ModelState.IsValid)` দিলে রেসপন্স ফরম্যাট নিজে নিয়ন্ত্রণ করতে পারো।

**Flutter এর সাথে তুলনা:**  
Flutter এ আমরা ফর্ম সাবমিটের সময় ভ্যালিডেশন চালিয়ে এরর মেসেজ UI তে দেখাই। এখানে সার্ভার সেই ভ্যালিডেশন করছে; ক্লায়েন্ট 400 পেলে সেই এরর তালিকা দিয়ে ফিল্ডের পাশে মেসেজ দেখাতে পারবে।

---

## ৩. ভ্যালিডেশন এরর রেসপন্স ফরম্যাট

**কী করবে:**  
ডিফল্ট `ModelState` রিটার্ন করলে ASP.NET একটা নির্দিষ্ট জসন শেপ দেয়। চাইলে একটা ছোট হেল্পার বা এক্সটেনশন বানিয়ে মডেল স্টেট থেকে শুধু ফিল্ড ও মেসেজ তালিকা নিয়ে একটা ক্লিন ডিকশনারি/অবজেক্ট বানাবে এবং সেটা 400 বডিতে দেবে। উদাহরণ ফরম্যাট:

```json
{
  "errors": {
    "FullName": ["নাম বাধ্যতামূলক"],
    "Email": ["সঠিক ইমেইল দিন"]
  }
}
```

এটা ক্লায়েন্টের জন্য পড়তে সহজ; Flutter অ্যাপে `response.data['errors']['FullName']` দিয়ে প্রথম এরর নিয়ে দেখাতে পারো।

**Flutter এর সাথে তুলনা:**  
Backend থেকে এরর স্ট্রাকচার একরকম থাকলে ফ্রন্টএন্ডে একইভাবে পার্স করে সব স্ক্রিনে দেখানো যায়। .NET এ আমরা শুধু রেসপন্স বডির “শেপ”টা ঠিক করে দিচ্ছি।

---

## ৪. (ঐচ্ছিক) গ্লোবাল ভ্যালিডেশন বা কাস্টম ফিল্টার

**কী করবে:**  
প্রতিটা অ্যাকশনে `if (!ModelState.IsValid)` না লিখে একটা **অ্যাকশন ফিল্টার** বা **ফিলুয়েন্ট ভ্যালিডেশন রেজাল্ট** ব্যবহার করতে পারো। যেমন: `ModelState` ইনভ্যালিড হলে অটোমেটিক 400 ও কাস্টম বডি রিটার্ন করে এমন ফিল্টার রেজিস্টার করলে কন্ট্রোলার কোড পরিষ্কার থাকে। এটা ঐচ্ছিক — প্রথমে কন্ট্রোলারেই চেক করলেই যথেষ্ট।

**Flutter এর সাথে তুলনা:**  
কেন্দ্রীয়ভাবে “যেকোনো রিকোয়েস্টে ভ্যালিডেশন ফেইল হলে এই ফরম্যাটে রেসপন্স দাও” — ফিল্টার সেই কাজটা এক জায়গায় করে দেয়।

---

## ৫. (ঐচ্ছিক) লগিং

**কী করবে:**  
কন্ট্রোলারে `ILogger<PatientsController>` ইনজেক্ট করে গুরুত্বপূর্ণ জায়গায় লগ লিখতে পারো: যেমন নতুন রোগী যোগ হলে `_logger.LogInformation("Patient created: {Id}", patient.Id);`, বা এক্সেপশন ধরা হলে `_logger.LogError(ex, "Error updating patient {Id}", id);`। `appsettings.json` এ লগ লেভেল (Information, Warning, Error) কনফিগ করতে পারো। খুব বড় কিছু না — শুধু অ্যাপটা চালানোর সময় কী হচ্ছে ট্রেস করা।

**Flutter এর সাথে তুলনা:**  
Flutter এ আমরা `debugPrint` বা `logger` প্যাকেজ দিয়ে লগ করি। .NET এ `ILogger` দিয়ে একই ধারণা; প্রোডাকশনে ফাইল বা ক্লাউড লগে পাঠানো যায়।

---

## ৬. (ঐচ্ছিক) হেলথ চেক

**কী করবে:**  
ASP.NET Core তে `Microsoft.Extensions.Diagnostics.HealthChecks` ও `AspNetCore.HealthChecks.Sqlite` (অথবা `NpgSql` যদি PostgreSQL ব্যবহার কর) নিউগেট প্যাকেজ যোগ করে হেলথ চেক রেজিস্টার করবে। `Program.cs` এ:

- `builder.Services.AddHealthChecks().AddDbContextCheck<PatientDbContext>("database");` (অথবা SQLite স্পেসিফিক চেক)
- `app.MapHealthChecks("/health");` বা `app.MapHealthChecks("/api/health");`

এটা একটা GET এন্ডপয়েন্ট দেবে: ডেটাবেস ঠিক থাকলে 200 OK, নইলে 503 Unhealthy। ক্লাউড বা লোড ব্যালান্সার অনেক সময় এই এন্ডপয়েন্ট দিয়ে অ্যাপ জীবিত কিনা চেক করে।

**Flutter এর সাথে তুলনা:**  
মোবাইল অ্যাপ থেকে “সার্ভার ঠিক আছে কিনা” চেক করার জন্য একটা সহজ পিং এন্ডপয়েন্ট — `/health` সেই কাজ করে।

---

## Phase-5 শেষে কী থাকবে (চোখে দেখার মতো)

- **DTO (CreatePatientRequest / UpdatePatientRequest):**

  - প্রপার্টিতে `[Required]`, `[EmailAddress]`, `[StringLength]`, `[Phone]`, `[Range]` ইত্যাদি অ্যানোটেশন।
  - ইংরেজি বা বাংলা `ErrorMessage` যেকোনোটা রাখতে পারো।

- **PatientsController:**

  - POST ও PUT এ `ModelState.IsValid` চেক; ইনভ্যালিড হলে 400 ও ভ্যালিডেশন এরর (ডিফল্ট বা কাস্টম ফরম্যাট)।

- **ঐচ্ছিক:**

  - কন্ট্রোলারে `ILogger` ব্যবহার করে ক্রিয়েশন/আপডেট/এরর লগ।
  - `/health` বা `/api/health` এ হেলথ চেক; ডেটাবেস চেক রেজিস্টার্ড।

- **চলবে:**
  - ভুল ডেটা (খালি নাম, ভুল ইমেইল) দিয়ে POST করলে 400 ও এরর তালিকা আসবে; সঠিক ডেটায় আগের মতো 201/200। চাইলে Swagger থেকে টেস্ট করে দেখো।

---

## Flutter vs .NET — Phase-5 এক নজরে

| ধারণা               | Flutter / Dart                 | .NET / C# (Phase-5)                                       |
| ------------------- | ------------------------------ | --------------------------------------------------------- |
| ভ্যালিডেশন নিয়ম    | validator ফাংশন / form_builder | DTO অ্যানোটেশন: `[Required]`, `[EmailAddress]`, `[Range]` |
| সার্ভার সাইড চেক    | Backend API রেসপন্স            | `ModelState.IsValid` → 400 + errors                       |
| এরর রেসপন্স ফরম্যাট | JSON from API                  | `BadRequest(ModelState)` বা কাস্টম `errors` অবজেক্ট       |
| লগিং                | debugPrint / logger            | `ILogger<T>` + LogInformation / LogError                  |
| অ্যাপ জীবিত চেক     | GET ping                       | `MapHealthChecks("/health")` + DB check                   |

---

## ছোট উপদেশ (টিউটর থেকে)

- প্রথমে শুধু একটা DTO (যেমন CreatePatientRequest) এ দু-একটা অ্যানোটেশন দিয়ে POST টেস্ট করো; 400 ও এরর বডি দেখে নাও। তারপর বাকি ফিল্ড ও UpdatePatientRequest এ যোগ করো।
- `[ApiController]` থাকলে বাইন্ড এরর (যেমন টাইপ মিসম্যাচ) ও ভ্যালিডেশন এরর অটোমেটিক ট্রিগার হয় — তাই কন্ট্রোলারে শুধু `if (!ModelState.IsValid)` দিলেই অনেকটা হয়ে যায়।
- হেলথ চেক ও লগিং ঐচ্ছিক; ভ্যালিডেশনটা অবশ্য করো যাতে খারাপ ডেটা ডেটাবেসে না ঢোকে।
- পরবর্তী ফেজে অথেনটিকেশন/অথরাইজেশন (JWT, API Key) বা আরও এনটিটি (ডাক্তার, অ্যাপয়েন্টমেন্ট) যোগ করা যাবে।

Phase-5 দিয়ে হাসপাতাল ম্যানেজমেন্ট API এর ভিত্তি ও পলিশ সম্পন্ন। ভ্যালিডেশন, সুন্দর এরর রেসপন্স, আর চাইলে হেলথ ও লগ — এগুলো দিয়ে পরবর্তী ফেজে সিকিউরিটি ও ফিচার বিস্তার করতে পারবে।  
শুভকামনা।
